name: Build and Deploy to Azure

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: source
        run: npm ci

      - name: Build frontend
        working-directory: source
        run: npm run build

      # Deploy to Azure Static Web App (created as swa-ak-aai-003)
      # Get the deployment token from the Static Web App resource and
      # store it as the repo secret AZURE_STATIC_WEB_APPS_API_TOKEN.
      - name: Deploy Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "source"        # path to Vite app
          api_location: ""              # no integrated SWA APIs; separate Function App is used
          output_location: "dist"       # build output from npm run build

  deploy-functions:
    runs-on: ubuntu-latest
    needs: build-and-deploy-frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Functions dependencies
        working-directory: functions
        run: npm install

      - name: Build Functions
        working-directory: functions
        run: npm run build

      - name: Deploy Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: "func-api-ak-aai-003"
          package: "./functions"
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          scm-do-build-during-deployment: false
          enable-oryx-build: false

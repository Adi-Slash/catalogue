name: Build and Deploy to Azure

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: source
        run: npm ci

      - name: Build frontend
        working-directory: source
        run: npm run build

      # Deploy to Azure Static Web App (created as swa-ak-aai-003)
      # Get the deployment token from the Static Web App resource and
      # store it as the repo secret AZURE_STATIC_WEB_APPS_API_TOKEN.
      - name: Deploy Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "source"        # path to Vite app
          api_location: ""              # no integrated SWA APIs; separate Function App is used
          output_location: "dist"       # build output from npm run build

  build-and-deploy-functions:
    runs-on: ubuntu-latest
    needs: build-and-deploy-frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Functions dependencies
        working-directory: functions
        run: |
          # Clean install to ensure no platform-specific binaries from other systems
          rm -rf node_modules package-lock.json
          # Install all dependencies including optional (needed for sharp)
          # GitHub Actions runs on Linux, so binaries will be Linux-compatible
          npm install --include=optional
          # Verify sharp is installed correctly
          test -d node_modules/sharp || (echo "ERROR: sharp not installed" && exit 1)

      - name: Build Functions
        working-directory: functions
        run: npm run build

      - name: Verify build output
        working-directory: functions
        run: |
          echo "Checking dist folder structure..."
          ls -la dist/ || echo "dist folder not found"
          ls -la dist/index.js || echo "dist/index.js not found"
          ls -la dist/functions/ || echo "dist/functions folder not found"
          echo "Checking required files..."
          ls -la host.json || echo "host.json not found"
          ls -la package.json || echo "package.json not found"

      - name: Prepare production deployment
        working-directory: functions
        env:
          # Ensure Linux binaries are maintained during prune
          npm_config_platform: linux
          npm_config_arch: x64
        run: |
          # Remove devDependencies but keep production dependencies including optional
          npm prune --production
          # Verify critical files exist
          test -f dist/index.js || (echo "ERROR: dist/index.js not found" && exit 1)
          test -f host.json || (echo "ERROR: host.json not found" && exit 1)
          test -f package.json || (echo "ERROR: package.json not found" && exit 1)
          # Verify sharp module exists
          test -d node_modules/sharp || (echo "ERROR: sharp module not found" && exit 1)
          # Verify sharp has Linux binaries (check for .node files)
          echo "Checking sharp installation..."
          find node_modules/sharp -name "*.node" | head -1 || echo "Warning: No .node files found in sharp"
          echo "âœ“ All required files present"

      - name: Verify deployment package structure
        working-directory: functions
        run: |
          echo "Final package structure:"
          echo "Files in functions directory:"
          ls -la
          echo "Files in dist directory:"
          ls -la dist/ || echo "dist not found"
          echo "Checking node_modules exists:"
          test -d node_modules && echo "node_modules exists" || echo "node_modules missing"

      - name: Deploy Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: "func-api-ak-aai-003"
          package: "./functions"
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          scm-do-build-during-deployment: false
          enable-oryx-build: false
